# 设备数据完整性检查脚本

## 概述

`api_data_integrity_checker.py` 是基于 `html_data_comparator.py` 裁剪并扩展的脚本，专门用于检查单个设备的数据完整性。

## 主要功能

1. **API接口数量检查**：检查接口返回的数据数量是否符合预期
   - 如果接口有size参数（如size=30），检查返回数量是否等于30
   - 如果接口不支持size参数，检查返回数量是否>0

2. **支持的API接口**：
   - 个性化推荐 (size=30)
   - Banner AD推荐 (size=1) 
   - 新个性化推荐 (size=30)
   - 栏目列表 (无size参数，检查>0)
   - 栏目内容 (无size参数，检查>0)

3. **完整性报告**：生成详细的Markdown格式报告

## 使用方法

### 基本使用

```bash
# 使用JDK17配置（默认）
python api_data_integrity_checker.py

# 使用JDK8配置
python api_data_integrity_checker.py jdk8

# 使用JDK17配置
python api_data_integrity_checker.py jdk17
```

### 配置说明

脚本支持两种配置：
- **jdk17**: 使用 `https://acc-saas-17.zeasn.tv` 服务器
- **jdk8**: 使用 `https://acc-saas.zeasn.tv` 服务器

## 检查项目

### 1. 主要API接口检查

| API接口 | 预期数量 | 检查规则 |
|---------|----------|----------|
| 个性化推荐 | 30 | 返回数量必须等于30 |
| Banner AD推荐 | 1 | 返回数量必须等于1 |
| 新个性化推荐 | 30 | 返回数量必须等于30 |
| 栏目列表 | >0 | 返回数量必须大于0 |

### 2. 栏目内容检查

- 获取所有栏目的叶子节点
- 检查每个栏目的内容数据
- 验证内容数量>0

## 输出结果

### 控制台输出
```
开始设备数据完整性检查 (JDK17)...
============================================================
1. 获取认证tokens...
成功获取token: abcd1234...
成功获取用户token: efgh5678...

2. 检查主要API接口...
   ✅ 个性化推荐: PASS
   ✅ Banner AD推荐: PASS
   ❌ 新个性化推荐: COUNT_MISMATCH
      错误: 期望30个，实际返回25个

3. 检查栏目内容...
   栏目内容检查: 8/10 通过
```

### 报告文件

生成格式：`API_Data_Integrity_Report_{config_type}_{timestamp}.md`

报告包含：
- 检查概述和统计
- 详细检查结果表格
- 问题分析和分类
- 性能统计
- 修复建议

## 错误类型

- **PASS**: 检查通过
- **COUNT_MISMATCH**: 数量不匹配
- **EMPTY_DATA**: 数据为空
- **API_ERROR**: API返回错误
- **REQUEST_ERROR**: 请求失败

## 特性

1. **网络连接检查**：自动检测网络连接状态
2. **重试机制**：请求失败时自动重试（最多3次）
3. **错误处理**：完善的异常处理和错误报告
4. **性能统计**：记录API响应时间
5. **限流保护**：请求间添加延迟避免过快

## 依赖库

```bash
pip install requests pandas urllib3
```

## 注意事项

1. 需要有效的网络连接访问API服务器
2. 栏目内容检查限制为前10个节点（避免过多请求）
3. 请求间有延迟保护，完整检查需要一定时间
4. 生成的报告文件使用UTF-8编码

## 示例报告

```markdown
# API数据完整性检查报告

**检查时间:** 2024-01-15 14:30:25
**API服务器:** https://acc-saas-17.zeasn.tv
**配置类型:** JDK17

## 检查概述

- **总检查项:** 14
- **通过检查:** 12
- **失败检查:** 2
- **通过率:** 85.7%

## 详细检查结果

| API接口 | 期望数量 | 实际数量 | 状态 | 错误信息 |
|---------|----------|----------|------|----------|
| 个性化推荐 | 30 | 30 | ✅ PASS | - |
| Banner AD推荐 | 1 | 1 | ✅ PASS | - |
| 新个性化推荐 | 30 | 25 | ❌ COUNT_MISMATCH | 期望30个，实际返回25个 |
```